`timescale 1ns/1ps

module tb_tag_cache_dm;

  reg clk = 0;
  always #5 clk = ~clk;

  reg rst;

  reg        req_valid;
  reg [31:0] req_addr;
  wire       req_ready;

  wire resp_valid;
  wire resp_hit;

  wire [31:0] hit_count;
  wire [31:0] miss_count;

  tag_cache_dm #(
    .ADDR_W(32),
    .LINE_BYTES(16),
    .LINES(64)
  ) dut (
    .clk(clk),
    .rst(rst),
    .req_valid(req_valid),
    .req_addr(req_addr),
    .req_ready(req_ready),
    .resp_valid(resp_valid),
    .resp_hit(resp_hit),
    .hit_count(hit_count),
    .miss_count(miss_count)
  );

  task do_req(input [31:0] a);
    begin
      @(negedge clk);
      req_addr  = a;
      req_valid = 1'b1;
      @(negedge clk);
      req_valid = 1'b0;

      @(posedge clk);
      if (resp_valid) begin
        $display("addr=%h hit=%0d  (hit=%0d miss=%0d)", a, resp_hit, hit_count, miss_count);
      end
    end
  endtask

  initial begin
    rst = 1;
    req_valid = 0;
    req_addr = 0;

    repeat (3) @(negedge clk);
    rst = 0;

    do_req(32'h0000_1000); 
    do_req(32'h0000_1000); 
    do_req(32'h0000_1000); 
    do_req(32'h0000_1004); 
    do_req(32'h0000_100C); 
    do_req(32'h0000_1000);
    do_req(32'h0001_1000); 
    do_req(32'h0000_1000); 

    $display("FINAL hit=%0d miss=%0d", hit_count, miss_count);
    $finish;
  end

endmodule
